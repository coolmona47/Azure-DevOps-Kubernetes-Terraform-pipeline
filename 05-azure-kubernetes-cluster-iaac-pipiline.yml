steps:
  - checkout: self

  - task: JasonBJohnson.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@1
    inputs:
      terraformVersion: '1.5.7'

  - script: |
      echo "##[group]Adding Terraform to PATH"
      export PATH="/opt/hostedtoolcache/terraform/1.5.7/x64:$PATH"
      terraform version
      echo "##[endgroup]"
    displayName: 'Check Terraform Version'

  # ✅ Login to Azure first
  - task: AzureCLI@2
    displayName: 'Azure Login'
    inputs:
      azureSubscription: 'azure-resorce-manager-service-connection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az account show

  # ✅ Terraform Init
  - script: |
      export PATH="/opt/hostedtoolcache/terraform/1.5.7/x64:$PATH"
      terraform init \
        -backend-config="resource_group_name=terraform-backend-rg" \
        -backend-config="storage_account_name=storageacctmohanxyz" \
        -backend-config="container_name=storageacctmohan" \
        -backend-config="key=kubernetes-dev.tfstate"
    displayName: 'Terraform Init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/configuration/iaac/azure/kubernetes'
